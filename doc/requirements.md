# 4x4 Pixel Diary 要件定義書

## 概要

4x4ピクセルアートを描いて他のユーザーと交換する日記アプリケーション。

**本要件定義書の対象範囲**: MVP（Phase 0〜2）。Phase 3以降のソーシャル/収益化機能は improvement-plans.md を参照。

## 機能要件

### FR-001: キャンバス描画

- 4x4（16ピクセル）のグリッドキャンバスを表示
- 各ピクセルはクリックで選択中の色に塗り替え
- 初期状態: 全ピクセル白色（#ffffff）

### FR-002: 色選択

- ネイティブカラーピッカー（`<input type="color">`）で任意の色を選択
- 選択中の色をプレビュー表示
- デフォルト色: #ffb7b2（ピンク）

### FR-003: タイトル入力

- 最大5文字
- 未入力時は「むだい」をデフォルト
- 絵文字は許可、特殊文字（キリル文字、不可視文字等）は不許可

### FR-004: 絵の交換

- 「こうかんする」ボタンで絵を投稿
- 投稿時、**他のユーザー**の未交換の絵とランダムに交換
- 交換相手がいない場合、交換待ちキューに保管

#### メッセージ

| ケース         | メッセージ                                         |
| -------------- | -------------------------------------------------- |
| 交換成功       | 「あなたの元に新しい絵がやってきました」           |
| 交換待ち       | 「投稿ありがとう！交換相手がいなかったので...」    |
| 同一盤面       | 「他の人が作成済みです。アルバムに保存しますか？」 |
| NGワード       | 「ネガティブな言葉が含まれています」               |
| レートリミット | 「しばらく待ってから再度お試しください」           |

#### バリデーション（クライアント・サーバー両方で実施）

| 条件                     | エラーメッセージ                               |
| ------------------------ | ---------------------------------------------- |
| 全白 かつ タイトル未入力 | 「キャンバスが真っ白で、タイトルもありません」 |
| HEXカラー形式不正        | 「無効な色が含まれています」                   |
| 特殊文字を含む           | 「使用できない文字が含まれています」           |

#### 自己投稿除外ルール

同一ユーザー（fingerprintで識別）の過去投稿すべてを交換対象から除外する。

#### 同一盤面ルール

既存の絵と同じpixels配列の場合:

- 自分の投稿はDBに保存されない
- 既存の同一盤面の絵データを返却
- 「アルバムに保存しますか？」と確認ダイアログを表示

### FR-005: アルバム表示

- 交換で受け取った絵を一覧表示
- ローカルストレージに永続化
- 新しい絵が先頭（降順）

### FR-006: 絵の詳細モーダル

- アルバムアイテムクリックで拡大表示
- タイトルと日付（MM/DD形式）を表示
- モーダル外クリックまたは×ボタンで閉じる

### FR-007: 絵の削除

- 各アルバムアイテムに×ボタン
- 確認ダイアログ（AlertDialog）: 「この絵をアルバムから削除しますか？」
- 承認後、ローカルストレージからも削除

### FR-008: オフライン対応

- オフライン時もアプリ起動・アルバム閲覧は可能（localStorage依存）
- 「こうかんする」は無効化し、「オフラインのため交換できません」を表示

### FR-009: fingerprint管理

- 初回訪問時にUUID v4を生成しlocalStorageに保存（キー: `pixel_diary_fingerprint`）
- 以降は再利用
- localStorage無効時はセッション中のみメモリ保持

### FR-010: 作業時間（アクティブ時間）の記録

- 投稿ごとに「作業時間（秒）」を記録する。
- 計測開始タイミング
    - 初回のユーザー操作時（いずれか）
        - ピクセル塗り
        - タイトル入力
        - カラー選択
- 計測終了タイミング
    - 「こうかんする」押下時（投稿リクエスト送信時）
- アクティブ時間の定義
    - 直近の操作から **IDLE_THRESHOLD**（例: 60秒）未満の間隔は「作業」とみなし、その差分を加算する。
    - IDLE_THRESHOLD以上の放置時間は作業時間に含めない。
- クライアントは投稿時に以下を送信する：
    - `work_seconds`: アクティブ時間の合計（整数秒）

---

## 非機能要件

### NFR-001: UI/UX

- 日本語UI
- ピクセルアート風デザイン
- フォント: DotGothic16（Google Fonts）
- レスポンシブ対応（モバイルファースト）
- image-rendering: pixelated
- ダークモード対応（next-themes）
- トースト通知（sonner）

### NFR-002: パフォーマンス

| 指標 | 閾値      |
| ---- | --------- |
| FCP  | 1.5秒以内 |
| LCP  | 2.5秒以内 |

### NFR-003: セキュリティ

- Supabase認証情報はサーバーサイドで管理
- RLSポリシーでデータアクセス制御
- 入力バリデーション（サーバーサイド必須）
    - HEXカラー形式検証（`/^#[0-9a-fA-F]{6}$/`）
    - 盤面データ検証（配列長16固定）
    - タイトル検証（5文字以内、トリム、特殊文字除去）
    - fingerprint検証（UUID v4形式）
    - 全白+タイトル空の拒否
    - NGワードチェック（部分一致、大文字小文字無視）
- レートリミット（RPC内でDB履歴を参照）
    - 短期: 3 posts/20sec
    - 長期: 20 posts/300sec

### NFR-004: ブラウザ対応

- Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

### NFR-005: PWA

- ホーム画面追加対応（manifest / icons）
- App Shell + 静的アセットのキャッシュ

### NFR-006: 作業時間の扱い・チート対策

- 作業時間は「おおまかな傾向を見る指標」とし、±数秒〜十数秒程度の誤差を許容する。
- サーバ側で `work_seconds` を簡易検証する：
    - `MIN_WORK_SECONDS` 未満（例: 5秒）の値は 0 として扱う
    - `MAX_WORK_SECONDS` 超過（例: 3600秒）の値は `MAX_WORK_SECONDS` にクリップ
- 作業時間はランキング等の競争要素には利用せず、主に分析・表示・演出目的で利用する。

---

## ユーザーフロー

```
アプリ起動
    │
    ├─ fingerprint確認（なければ生成）
    │
    ▼
ローカルストレージからアルバム読み込み → 表示
    │
    ▼
キャンバス描画
  1. 色を選択
  2. ピクセルをクリック
  3. タイトル入力（任意）
    │
    ▼
「こうかんする」クリック
    │
    ├─ オフライン → 無効化メッセージ
    │
    ├─ レートリミット超過 → トースト表示
    │
    ├─ バリデーションエラー → トースト表示
    │
    └─ 成功 → サーバーサイド交換API呼び出し
                │
                ├─ 交換成功 → アルバム追加 + トースト
                │
                ├─ 同一盤面 → 保存確認ダイアログ → (Yes) アルバム追加
                │
                └─ 交換待ち → トースト
                        │
                        ▼
                  キャンバスリセット
```

## デザイン仕様

### カラーパレット

| 変数名            | ライト  | ダーク  | 用途                 |
| ----------------- | ------- | ------- | -------------------- |
| --border-color    | #222    | #e5e5e5 | メインボーダー       |
| --inactive-border | #d4d4d4 | #525252 | 非アクティブボーダー |
| --bg-color        | #fffbf0 | #1a1a1a | 背景色               |
| --container-bg    | #ffffff | #262626 | コンテナ背景         |
| アクセント        | #ffb7b2 | #ffb7b2 | ボタン、ハイライト   |

### レイアウト

| 要素                     | サイズ        |
| ------------------------ | ------------- |
| メインコンテナ幅         | 300px         |
| キャンバス               | 200px × 200px |
| アルバムセクション最大幅 | 600px         |
| ミニグリッド             | 80px × 80px   |
| モーダルグリッド         | 240px × 240px |
